<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sari-Sari Store - Tindahan ni Mare (Updated)</title>
<style>
/* ---------- STYLES (same as before + small tweaks) ---------- */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial, Helvetica, sans-serif;background:#f5f9f0;color:#333;transition:0.3s;background-size:cover;background-position:center}
body.dark{background:#1a1a1a;color:#f0f0f0}
.emoji{font-family:"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Segoe UI Symbol","EmojiSymbols";line-height:1;display:inline-block}
body.dark .emoji{ color:inherit; }
body.dark input, body.dark select, body.dark textarea, body.dark p, body.dark label, body.dark span, body.dark strong { color: #f0f0f0; }
body.dark input, body.dark select, body.dark textarea { background:#2b2b2b; border-color:#555; }
body.dark ::placeholder { color: #bfbfbf; }

.logo-img{height:45px;width:45px;border-radius:50%;object-fit:cover;border:2px solid #9acd32;background:white}
.prod-thumb{width:50px;height:50px;object-fit:cover;border-radius:5px;border:1px solid #ddd}
body.dark .card{background:#2a2a2a}
body.dark nav{background:#2a2a2a}
body.dark main{background:#1a1a1a}
body.dark .box{background:#2a2a2a;color:#f0f0f0}
body.dark h1,body.dark h3{color:#9acd32}
body.dark table{background:#2a2a2a}
body.dark td{color:#f0f0f0}
body.dark p{color:#f0f0f0}
body.dark .error{color:#ffb3b3;background:#4a1a1a}
body.dark .link{color:#9acd32}
body.dark table th{background:#1a1a1a;color:#f0f0f0}
body.dark .stat{background:#333;color:#f0f0f0}
body.dark .stat-num{color:#9acd32}
body.dark .card#announce{background:#1a2a4a!important;color:#f0f0f0}
body.dark #notlist>div{background:#1a3a6a!important;color:#f0f0f0}
body.dark #actacc{color:#f0f0f0}
body.dark #actacc .acc-item{background:#333;color:#f0f0f0}
body.dark #actacc .acc-item strong{color:#f0f0f0}
body.dark #pend .acc-item{background:#333;color:#f0f0f0}
body.dark #pend .acc-item strong{color:#f0f0f0}
body.dark #accs .acc-item{background:#333;color:#f0f0f0}
body.dark #accs .acc-item strong{color:#f0f0f0}
body.dark #accs .acc-item span{color:#f0f0f0}

.recovery-inner{background:white;padding:15px;border-radius:6px;margin-top:10px;color:inherit}
body.dark .recovery-inner{ background:#2b2b2b; color:#f0f0f0; border:1px solid #3a3a3a; }

.screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#2d5016,#6b8e23);display:flex;align-items:center;justify-content:center}
.hidden{display:none!important}
.box{background:white;padding:40px;border-radius:10px;width:90%;max-width:400px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
.box h2{color:#2d5016;margin-bottom:20px;font-size:2rem}
.box input,.box select,.box textarea{width:100%;padding:12px;margin:10px 0;border:2px solid #ddd;border-radius:6px;font-size:1rem}
.box button{width:100%;padding:12px;background:linear-gradient(135deg,#2d5016,#6b8e23);color:white;border:none;border-radius:6px;font-weight:bold;cursor:pointer;margin-top:15px}
.box button:hover{opacity:0.95}
.error{color:red;margin:10px 0;font-weight:bold}
.link{margin-top:15px;color:#2d5016;cursor:pointer;font-weight:600;text-decoration:underline}
.app{display:none}
header{background:linear-gradient(135deg,#2d5016,#6b8e23);color:white;padding:10px 15px;display:flex;justify-content:space-between;align-items:center;gap:10px}
.hamburger{background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;padding:10px}
.hamburger span{display:block;width:25px;height:3px;background:white;margin:5px 0}
.container{display:flex;min-height:calc(100vh - 60px)}
nav{width:220px;background:white;padding:15px 0;border-right:2px solid #ddd;overflow-y:auto}
nav.hidden{display:none}
.nav-item{padding:12px 16px;cursor:pointer;border-left:4px solid transparent;transition:0.3s;display:flex;gap:8px;align-items:center}
.nav-item:hover{background:#f0f0f0}
.nav-item.active{background:#f0f0f0;border-left-color:#6b8e23;color:#2d5016;font-weight:bold}
main{flex:1;padding:30px;overflow-y:auto}
.section{display:none}
.section.active{display:block}
h1{color:#2d5016;margin-bottom:20px;border-bottom:3px solid #9acd32;padding-bottom:10px}
h3{color:#2d5016;margin-top:15px;margin-bottom:10px}
.card{background:white;padding:20px;border-radius:8px;margin:20px 0;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:20px 0}
.stat{background:#f0f0f0;padding:20px;border-radius:8px;text-align:center}
.stat-num{font-size:2rem;color:#2d5016;font-weight:bold}
table{width:100%;border-collapse:collapse;margin-top:15px}
th{background:#2d5016;color:white;padding:12px;text-align:left}
td{padding:12px;border-bottom:1px solid #e0e0e0;vertical-align:middle}
.btn{padding:10px 15px;background:#2d5016;color:white;border:none;border-radius:5px;cursor:pointer;margin-right:10px;margin-bottom:10px}
.btn:hover{opacity:0.8}
.btn-danger{background:#c85a54}
.btn-success{background:#28a745}
input,select,textarea{width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:4px;font-family:Arial}
.acc-item{background:#f9f9f9;padding:12px;margin:10px 0;border-radius:6px;display:flex;justify-content:space-between;align-items:center}
.acc-item.pending{background:#fff3cd}
.small-muted{font-size:0.9rem;color:#666}
.brand-preview{display:flex;gap:10px;align-items:center}
.brand-preview img{height:60px;width:60px;border-radius:8px;object-fit:cover;border:1px solid #ddd}
.pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
.pager button{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
.pager .active{background:#2d5016;color:#fff;border-color:#2d5016}
.badge-low{background:#ffc107;color:#2d5016;padding:4px 8px;border-radius:12px;font-weight:bold}
.badge-exp{background:#dc3545;color:#fff;padding:4px 8px;border-radius:8px}
.notif-badge{background:#dc3545;color:#fff;border-radius:50%;padding:2px 7px;font-size:11px;font-weight:bold;margin-left:4px;vertical-align:middle}
.alert-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:9999}
.alert-modal-box{background:#fff;border-radius:12px;padding:28px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:0 15px 50px rgba(0,0,0,0.4)}
body.dark .alert-modal-box{background:#2a2a2a;color:#f0f0f0}
.alert-section{margin:12px 0;padding:12px;border-radius:8px}
.alert-section.expired{background:#fdecea;border-left:4px solid #dc3545}
.alert-section.outstock{background:#fff8e1;border-left:4px solid #ff9800}
.alert-section.overdue{background:#e8f5e9;border-left:4px solid #e53935}
body.dark .alert-section.expired{background:#4a1a1a}
body.dark .alert-section.outstock{background:#3a2e00}
body.dark .alert-section.overdue{background:#1a3a1a}
.alert-item{font-size:0.92rem;padding:4px 0;border-bottom:1px solid rgba(0,0,0,0.07)}
.alert-item:last-child{border-bottom:none}
</style>
</head>
<body>
<!-- ---------- LOGIN / SCREENS ---------- -->
<div id="login" class="screen">
  <div class="box">
    <img id="mainLogo" src="1000017768.png" style="width:100px;height:100px;border-radius:50%;margin-bottom:10px;border:3px solid #6b8e23">
    <h2>Tindahan ni Mare</h2>
    <div class="error" id="err"></div>
    <select id="role"><option value="">Select Role</option><option value="admin">Admin</option><option value="owner">Owner</option><option value="employee">Employee</option></select>
    <input type="text" id="user" placeholder="Username">
    <input type="password" id="pass" placeholder="Password">
    <button onclick="doLogin()">LOGIN</button>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div class="link" onclick="toSignup()">Create Account</div>
      <div class="link" onclick="showForgotOptions()">Forgot username/password?</div>
    </div>
  </div>
</div>

<div id="signup" class="screen hidden">
  <div class="box">
    <h2>Create Account</h2>
    <div class="error" id="err2"></div>
    <select id="srole"><option value="">Select Role</option><option value="owner">Owner</option><option value="employee">Employee</option></select>
    <input type="text" id="suser" placeholder="Username">
    <input type="password" id="spass" placeholder="Password">
    <input type="password" id="spass2" placeholder="Confirm">
    <button onclick="doSignup()">CREATE</button>
    <div class="link" onclick="toLogin()">Back</div>
  </div>
</div>

<div id="forgotOptions" class="screen hidden">
  <div class="box">
    <h2>Account Recovery</h2>
    <p class="small-muted">Choose recovery method</p>
    <button class="btn btn-success" onclick="showAdminRecovery()" style="margin-top:12px"><span class="emoji">‚≠ê</span> Admin Emergency Recovery</button>
    <button class="btn" onclick="showUserRecovery()" style="margin-top:12px;background:#ffc107"><span class="emoji">üìú</span> Submit Recovery Request (Owner/Employee)</button>
    <div class="link" onclick="toLogin()">Back to Login</div>
  </div>
</div>

<div id="adminRecovery" class="screen hidden">
  <div class="box">
    <h2>Admin Emergency Recovery</h2>
    <p class="small-muted">Enter emergency code (admin-only)</p>
    <input type="text" id="emergencyCode" placeholder="Emergency Code">
    <div style="display:flex;gap:10px">
      <button class="btn btn-success" onclick="adminRecovery()">Use Code</button>
      <button class="btn" onclick="toLogin()" style="background:#666">Cancel</button>
    </div>
    <p style="margin-top:12px;font-size:0.9rem;color:#666">If code is valid you'll be prompted to set a new admin username/password.</p>
  </div>
</div>

<div id="userRecovery" class="screen hidden">
  <div class="box">
    <h2>Submit Recovery Request</h2>
    <div class="error" id="recErr"></div>
    <select id="recRole"><option value="">Select Role</option><option value="owner">Owner</option><option value="employee">Employee</option></select>
    <input type="text" id="recUser" placeholder="Your Username (if known)">
    <textarea id="recReason" placeholder="Describe issue (e.g. forgot password)" style="height:80px"></textarea>
    <div style="display:flex;gap:10px">
      <button class="btn btn-success" onclick="submitRecoveryRequest()">Submit</button>
      <button class="btn" onclick="toLogin()" style="background:#666">Cancel</button>
    </div>
  </div>
</div>

<!-- ---------- APP ---------- -->
<div id="app" class="app">
  <header id="appHeader">
    <div style="display:flex;align-items:center;gap:10px">
      <button class="hamburger" onclick="toggleMenu()"><span></span><span></span><span></span></button>
      <img id="headerLogo" src="logo.png" class="logo-img">
    </div>
    <div id="uinfo" style="color:white;flex:1;text-align:right;padding-right:15px"></div>
    <button class="btn" onclick="toggleDark()" style="margin:0 5px;background:rgba(255,255,255,0.2)"><span class="emoji">üåó</span></button>
    <button class="btn" onclick="doLogout()" style="margin:0">LOGOUT</button>
  </header>

  <div class="container">
    <nav id="nav">
      <div class="nav-item active" onclick="goTo('dash')"><span class="emoji">üìä</span><span>Dashboard</span></div>
      <div class="nav-item" onclick="goTo('inv')"><span class="emoji">üì¶</span><span>Inventory</span></div>
      <div class="nav-item" onclick="goTo('prod')"><span class="emoji">üßæ</span><span>Products</span></div>
      <div class="nav-item" id="salesMenu" onclick="goTo('sales')"><span class="emoji">üíµ</span><span>Sales</span></div>
      <div class="nav-item" onclick="goTo('utang')"><span class="emoji">üí≥</span><span>Utang (Credit)</span></div>
      <div class="nav-item" onclick="goTo('suppliers')"><span class="emoji">üè∑Ô∏è</span><span>Suppliers</span></div>
      <div class="nav-item" onclick="goTo('purchase')"><span class="emoji">üì•</span><span>Purchase / Restock</span></div>
      <div class="nav-item" onclick="goTo('reports')"><span class="emoji">üìà</span><span>Reports</span></div>
      <div class="nav-item" id="admenu" style="display:none" onclick="goTo('admin')"><span class="emoji">üîê</span><span>Admin</span></div>
      <div class="nav-item" onclick="goTo('notif')"><span class="emoji">üîî</span><span>Notifications</span><span id="notifBadge" class="notif-badge" style="display:none">0</span></div>
      <div class="nav-item" onclick="goTo('settings')"><span class="emoji">‚öôÔ∏è</span><span>Settings</span></div>
    </nav>

    <main>
      <!-- DASHBOARD -->
      <div id="dash" class="section active">
        <h1><span class="emoji">üìä</span> Dashboard</h1>
        <div class="card" id="announce" style="background:#e3f2fd;border-left:5px solid #2196f3"></div>
        <div class="stats">
          <div class="stat"><div class="stat-num" id="items">0</div>Items</div>
          <div class="stat"><div class="stat-num" id="stock">0</div>Stock</div>
          <div class="stat"><div class="stat-num" id="out">0</div>Out</div>
          <div class="stat"><div class="stat-num" id="exp">0</div>Expired</div>
        </div>
        <div class="card">
          <h3>Quick Actions</h3>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" onclick="showAddModal()">‚ûï Add Product</button>
            <button class="btn" onclick="openSalesModal()">üíµ New Sale</button>
            <button class="btn" onclick="goTo('purchase')">üì• Restock</button>
            <button class="btn" onclick="goTo('reports')">üìà View Reports</button>
          </div>
        </div>
      </div>

      <!-- INVENTORY (with pagination, unit support) -->
      <div id="inv" class="section">
        <h1><span class="emoji">üì¶</span> Inventory</h1>
        <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" onclick="addItem()"><span class="emoji">‚ûï</span> Add Product</button>
          <button class="btn" onclick="exportCSV()">Export CSV</button>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <label class="small-muted">Show</label>
            <select id="itemsPerPage" onchange="setItemsPerPage(this.value)"><option value="5">5</option><option value="10" selected>10</option><option value="25">25</option></select>
          </div>
        </div>

        <input type="text" id="search" placeholder="Search product..." onkeyup="filter()" style="width:100%;margin-bottom:15px">
        <div class="card" style="overflow-x:auto">
          <table>
            <thead>
              <tr><th>#</th><th>Image</th><th>Item</th><th>Cat</th><th>Qty</th><th>Unit</th><th>Price</th><th>Supplier</th><th>Exp</th><th>Status</th><th>Stock</th><th>Act</th></tr>
            </thead>
            <tbody id="invtab"></tbody>
          </table>
          <div class="pager" id="pager"></div>
        </div>
      </div>

      <!-- PRODUCTS (simple list) -->
      <div id="prod" class="section">
        <h1><span class="emoji">üßæ</span> Products</h1>
        <div class="card" style="overflow-x:auto">
          <table>
            <thead><tr><th>#</th><th>Image</th><th>Product</th><th>Cat</th><th>Qty</th><th>Unit</th><th>Selling</th></tr></thead>
            <tbody id="prodtab"></tbody>
          </table>
        </div>
      </div>

      <!-- SALES -->
      <div id="sales" class="section">
        <h1><span class="emoji">üíµ</span> Sales</h1>
        <div class="card">
          <button class="btn btn-success" onclick="openSalesModal()">New Sale</button>
          <button class="btn" onclick="openSalesHistory()">View Sales History</button>
        </div>
        <div class="card" id="salesHistory" style="display:none;overflow-x:auto"></div>
      </div>

      <!-- UTANG -->
      <div id="utang" class="section">
        <h1><span class="emoji">üí≥</span> Utang (Credit)</h1>
        <div class="card">
          <button class="btn btn-success" onclick="openAddCustomer()">Add Customer</button>
          <button class="btn" onclick="openUtangPayments()">Record Payment</button>
        </div>
        <div class="card" id="customerList" style="overflow-x:auto"></div>
      </div>

      <!-- SUPPLIERS -->
      <div id="suppliers" class="section">
        <h1><span class="emoji">üè∑Ô∏è</span> Suppliers</h1>
        <div class="card">
          <button class="btn btn-success" onclick="openAddSupplier()">Add Supplier</button>
        </div>
        <div class="card" id="supplierList"></div>
      </div>

      <!-- PURCHASE -->
      <div id="purchase" class="section">
        <h1><span class="emoji">üì•</span> Purchase / Restock</h1>
        <div class="card">
          <button class="btn btn-success" onclick="openPurchaseModal()">New Purchase / Stock-in</button>
        </div>
        <div class="card" id="purchaseList" style="overflow-x:auto"></div>
      </div>

      <!-- REPORTS -->
      <div id="reports" class="section">
        <h1><span class="emoji">üìà</span> Reports</h1>
        <div class="card">
          <h3>Sales Summary</h3>
          <div id="reportSummary"></div>
        </div>
      </div>

      <!-- ADMIN -->
      <div id="admin" class="section">
        <h1><span class="emoji">üîê</span> Admin</h1>
        <h3><span class="emoji">üì£</span> Announcement</h3>
        <div class="card"><textarea id="ann" placeholder="Type..." style="height:80px"></textarea><button class="btn btn-success" onclick="postAnn()">Post</button></div>

        <h3>Pending Accounts</h3>
        <div class="card" id="pend"></div>

        <h3>Recovery Requests</h3>
        <div class="card" id="recreq"></div>

        <h3>All Accounts</h3>
        <div class="card" id="accs"></div>
      </div>

      <!-- NOTIFICATIONS -->
      <div id="notif" class="section">
        <h1><span class="emoji">üîî</span> Notifications</h1>
        <button class="btn btn-danger" onclick="clearNotif()">Clear All</button>
        <div class="card" id="notlist"></div>
      </div>

      <!-- SETTINGS -->
      <div id="settings" class="section">
        <h1><span class="emoji">‚öôÔ∏è</span> Settings</h1>

        <h3>Change Username</h3>
        <div class="card">
          <input type="text" id="newUsername" placeholder="New Username">
          <button class="btn btn-success" onclick="changeUsername()">Update Username</button>
        </div>

        <h3>Change Password</h3>
        <div class="card">
          <input type="password" id="curr" placeholder="Current Password">
          <input type="password" id="new" placeholder="New Password">
          <input type="password" id="new2" placeholder="Confirm Password">
          <button class="btn btn-success" onclick="changePass()">Update</button>
        </div>

        <h3>Branding (Logo & Background)</h3>
        <div class="card" id="brandingCard">
          <div class="brand-preview" style="margin-bottom:10px">
            <img id="brandLogoPreview" src="logo.png" alt="logo preview">
            <div>
              <p style="margin:0"><strong>Current Logo</strong></p>
              <p class="small-muted" style="margin:0">Only admin can change this</p>
            </div>
          </div>
          <input type="file" id="brandLogo" accept="image/*">
          <p style="margin:8px 0" class="small-muted">Background (login page background) ‚Äî <strong>admin only</strong></p>
          <div style="margin-bottom:8px">
            <img id="bgPreview" src="" style="max-width:100%;max-height:120px;display:none;border-radius:6px;border:1px solid #ddd">
          </div>
          <input type="file" id="brandBg" accept="image/*">
          <div style="display:flex;gap:10px;margin-top:10px">
            <button class="btn btn-success" onclick="saveBranding()">Save Branding</button>
            <button class="btn" onclick="clearBranding()" style="background:#666">Remove</button>
          </div>
        </div>

        <h3>Recovery Information</h3>
        <div class="card" style="background:#fff3cd;border-left:4px solid #ffc107">
          <p style="margin-bottom:10px;color:#856404"><strong><span class="emoji">‚ö†Ô∏è</span> Save this information:</strong></p>
          <div class="recovery-inner">
            <p><strong>Your Username:</strong> <span id="currentUser" style="color:#2d5016;font-size:1.1rem"></span></p>
            <p style="margin-top:8px"><strong>Your Role:</strong> <span id="currentRole" style="color:#2d5016;font-size:1.1rem"></span></p>
          </div>
          <p style="margin-top:10px;font-size:0.9rem;color:#856404"><span class="emoji">üí°</span> Take a screenshot or write this down in case you forget!</p>
        </div>

        <h3 id="owntit" style="display:none">Pending Employees</h3>
        <div class="card" id="ownpend" style="display:none"></div>
        <h3>Active Team</h3>
        <div class="card" id="actacc"></div>

        <h3>Backup & Data</h3>
        <div class="card">
          <button class="btn" onclick="exportData()">Export Full Backup</button>
          <input type="file" id="importFile" accept="application/json" style="margin-top:10px">
          <button class="btn btn-success" onclick="importData()">Import Backup</button>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- ---------- SCRIPT (logic) ---------- -->
<script>
/* ===== Data / initial state (with unit support and low-stock threshold) ===== */
let users = { admin: [{ u: 'admin', p: 'admin123', ok: 1 }], owner: [{ u: 'owner', p: 'owner123', ok: 1 }], employee: [{ u: 'employee', p: 'emp123', ok: 1 }] };
// inv items: n (name), c (category), q (qty), e (expiry), img (image), cost, price, supplier, barcode, unit (pcs/pack/case/kg), unitSize (number), low (low-stock threshold)
let inv = [
  { n: 'Nissin Cup Noodles', c: 'snacks', q: 50, e: '2025-06-15', img: '1000017768.png', cost: 12, price: 15, supplier: 'Local Wholesaler', barcode: 'NC001', unit: 'pcs', unitSize: 1, low: 5 },
  { n: 'Yellow Notebook', c: 'supplies', q: 60, e: '2026-12-31', img: '', cost: 25, price: 40, supplier: 'Stationery Co', barcode: 'NB001', unit: 'pcs', unitSize: 1, low: 5 }
];
let pending = [], ann = '', user = null, role = null, recoveryRequests = [];
let nots = {}; // notifications per-user map
let sales = JSON.parse(localStorage.getItem('sales') || '[]');
let customers = JSON.parse(localStorage.getItem('customers') || '[]');
let suppliers = JSON.parse(localStorage.getItem('suppliers') || '[]');
let purchases = JSON.parse(localStorage.getItem('purchases') || '[]');

/* pagination state */
let currentPage = 1;
let itemsPerPage = parseInt(localStorage.getItem('itemsPerPage') || '10');

function load(){
  let d = localStorage.getItem('s18');
  if(d){
    try {
      let x = JSON.parse(d);
      users = x.u || users;
      inv = x.i || inv;
      pending = x.p || pending;
      nots = x.n || nots;
      ann = x.a || ann;
      recoveryRequests = x.r || recoveryRequests;
    } catch(e) { console.warn('load parse failed', e); }
  }
  if(localStorage.getItem('branding')){
    applyBranding(JSON.parse(localStorage.getItem('branding')));
  } else {
    resetLoginBackgroundToDefault();
  }
  if(localStorage.getItem('dark') === '1') document.body.classList.add('dark');
}
function save(){
  localStorage.setItem('s18', JSON.stringify({ u: users, i: inv, p: pending, n: nots, a: ann, r: recoveryRequests }));
  localStorage.setItem('sales', JSON.stringify(sales));
  localStorage.setItem('customers', JSON.stringify(customers));
  localStorage.setItem('suppliers', JSON.stringify(suppliers));
  localStorage.setItem('purchases', JSON.stringify(purchases));
  localStorage.setItem('itemsPerPage', itemsPerPage.toString());
}
load();

/* theme */
function toggleDark(){ document.body.classList.toggle('dark'); localStorage.setItem('dark', document.body.classList.contains('dark') ? '1' : '0'); }

/* notifications */
function addNotification(msg){
  if(!user) return;
  if(!nots[user]) nots[user] = [];
  nots[user].push(msg);
  save();
}

/* Login/Signup flows */
function toSignup(){ document.getElementById('login').classList.add('hidden'); document.getElementById('signup').classList.remove('hidden'); hideAllRecoveryScreens(); }
function toLogin(){ hideAllTopScreens(); document.getElementById('login').classList.remove('hidden'); document.getElementById('signup').classList.add('hidden'); }
function showForgotOptions(){ hideAllTopScreens(); document.getElementById('forgotOptions').classList.remove('hidden'); }
function showAdminRecovery(){ hideAllTopScreens(); document.getElementById('adminRecovery').classList.remove('hidden'); }
function showUserRecovery(){ hideAllTopScreens(); document.getElementById('userRecovery').classList.remove('hidden'); }
function hideAllTopScreens(){ document.getElementById('login').classList.add('hidden'); document.getElementById('signup').classList.add('hidden'); document.getElementById('forgotOptions').classList.add('hidden'); document.getElementById('adminRecovery').classList.add('hidden'); document.getElementById('userRecovery').classList.add('hidden'); }
function hideAllRecoveryScreens(){ document.getElementById('forgotOptions').classList.add('hidden'); document.getElementById('adminRecovery').classList.add('hidden'); document.getElementById('userRecovery').classList.add('hidden'); }

function doSignup(){
  let r = document.getElementById('srole').value, u = document.getElementById('suser').value.trim(), p = document.getElementById('spass').value, p2 = document.getElementById('spass2').value, e = document.getElementById('err2');
  e.innerText = '';
  if(!r||!u||!p||!p2){ e.innerText='Fill all fields'; return; }
  if(p!==p2){ e.innerText='Passwords do not match'; return; }
  if(pending.some(x=>x.u===u)){ e.innerText='Already requested'; return; }
  pending.push({ u, p, r }); save(); alert('‚úì Request Sent! Wait for Admin/Owner approval.'); toLogin();
}

function doLogin(){
  let r = document.getElementById('role').value, u = document.getElementById('user').value.trim(), p = document.getElementById('pass').value, e = document.getElementById('err');
  e.innerText = '';
  if(!r||!u||!p){ e.innerText='Fill all'; return; }
  if(!users[r]){ e.innerText='Wrong Credentials'; return; }
  let a = users[r].find(x=>x.u===u&&x.p===p);
  if(!a){ e.innerText='Wrong Credentials'; return; }
  if(!a.ok){ e.innerText='Account pending/deactivated'; return; }
  user = u; role = r;
  document.getElementById('login').classList.add('hidden'); document.getElementById('app').style.display='block'; hideAllTopScreens();
  document.getElementById('uinfo').innerText = u + ' (' + r.toUpperCase() + ')';
  document.getElementById('currentUser').innerText = user;
  document.getElementById('currentRole').innerText = role;

  document.getElementById('admenu').style.display = (role==='admin') ? 'block' : 'none';
  document.getElementById('brandingCard').style.display = (role==='admin') ? 'block' : 'none';
  document.getElementById('actacc').style.display = (role==='admin' || role==='owner') ? 'block' : 'none';

  showAnn(); render(); loadAdmin(); loadNot(); loadAccountsView(); loadCustomers(); loadSuppliers(); loadPurchases();
  setTimeout(autoCheckAlerts, 500);
}

/* ---------- RENDER / SEARCH / PAGINATION ---------- */
function setItemsPerPage(n){
  itemsPerPage = parseInt(n) || 10;
  localStorage.setItem('itemsPerPage', itemsPerPage.toString());
  currentPage = 1;
  render();
}

function render(){
  // Inventory table with pagination & product unit display
  let t = document.getElementById('invtab'), p = document.getElementById('prodtab');
  t.innerHTML = ''; p.innerHTML = '';
  let tot = 0, qty = 0, out = 0, exp = 0;

  inv.forEach(it => { tot++; qty += it.q; if(it.q === 0) out++; if(new Date(it.e) < new Date()) exp++; });

  // Filtering
  let f = document.getElementById('search') ? document.getElementById('search').value.trim().toUpperCase() : '';
  let filtered = inv.map((it, i) => ({ it, i })).filter(row => {
    if(!f) return true;
    let text = (row.it.n + ' ' + (row.it.c||'') + ' ' + (row.it.barcode||'') + ' ' + (row.it.supplier||'')).toUpperCase();
    return text.includes(f);
  });

  // Pagination
  let totalPages = Math.max(1, Math.ceil(filtered.length / itemsPerPage));
  if(currentPage > totalPages) currentPage = totalPages;
  let start = (currentPage - 1) * itemsPerPage;
  let pageRows = filtered.slice(start, start + itemsPerPage);

  pageRows.forEach(({ it, i }, idx) => {
    let isExp = new Date(it.e) < new Date();
    let imgHtml = it.img ? `<img src="${it.img}" class="prod-thumb">` : `<div class="prod-thumb" style="background:#eee;display:flex;align-items:center;justify-content:center;font-size:10px;color:#999">No Image</div>`;
    let actButtons = '';
    if(role === 'owner' || role === 'admin') actButtons = `<button class="btn btn-danger" onclick="del(${i})">Del</button> <button class="btn" onclick="edit(${i})">Edit</button>`;
    else actButtons = `<button class="btn" onclick="edit(${i})">Edit</button>`;

    // unit display
    let unitDisplay = '';
    if(it.unit){
      if(it.unitSize && it.unitSize > 1) unitDisplay = `${it.unitSize} / ${it.unit}`;
      else unitDisplay = it.unit;
    } else unitDisplay = 'pcs';

    // low stock indicator
    let lowBadge = (typeof it.low === 'number' && it.q <= it.low) ? `<span class="badge-low">Low</span>` : '';

    t.innerHTML += `<tr>
      <td>${i+1}</td>
      <td>${imgHtml}</td>
      <td><strong>${it.n}</strong><div class="small-muted">Barcode: ${it.barcode||'‚Äî'}</div></td>
      <td><span style="background:#ffd4a3;padding:4px 8px;border-radius:12px;font-size:12px">${it.c}</span></td>
      <td>${it.q}</td>
      <td>${unitDisplay}</td>
      <td>${it.price ? ('‚Ç±' + it.price) : '‚Äî'}</td>
      <td>${it.supplier||'‚Äî'}</td>
      <td>${it.e}</td>
      <td>${isExp ? '<span class="badge-exp">EXP</span>' : '<span style="background:#28a745;color:white;padding:4px 8px;border-radius:4px;font-size:0.85rem">OK</span>'}</td>
      <td>${it.q===0 ? '<span style="background:#dc3545;color:white;padding:4px 8px;border-radius:12px;font-size:12px">OUT</span>' : lowBadge}</td>
      <td>${actButtons}</td>
    </tr>`;

    p.innerHTML += `<tr><td>${i+1}</td><td>${imgHtml}</td><td>${it.n}</td><td>${it.c}</td><td>${it.q}</td><td>${unitDisplay}</td><td>${it.price?('‚Ç±'+it.price):'‚Äî'}</td></tr>`;
  });

  // update top stats
  document.getElementById('items').innerText = tot;
  document.getElementById('stock').innerText = qty;
  document.getElementById('out').innerText = out;
  document.getElementById('exp').innerText = exp;

  // pager
  renderPager(totalPages);
  save();
}

function renderPager(totalPages){
  let pager = document.getElementById('pager');
  if(!pager) return;
  let html = '';
  html += `<div style="margin-right:auto" class="small-muted">Page ${currentPage} / ${totalPages}</div>`;
  if(totalPages <= 1){
    pager.innerHTML = html;
    return;
  }
  html += `<div>`;
  html += `<button onclick="changePage(1)" ${currentPage===1?'disabled':''}>‚èÆÔ∏è</button>`;
  html += `<button onclick="changePage(${currentPage-1})" ${currentPage===1?'disabled':''}>‚óÄ</button>`;
  let start = Math.max(1, currentPage - 2);
  let end = Math.min(totalPages, currentPage + 2);
  for(let i=start;i<=end;i++){
    html += `<button class="${i===currentPage?'active':''}" onclick="changePage(${i})">${i}</button>`;
  }
  html += `<button onclick="changePage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>‚ñ∂</button>`;
  html += `<button onclick="changePage(${totalPages})" ${currentPage===totalPages?'disabled':''}>‚è≠Ô∏è</button>`;
  html += `</div>`;
  pager.innerHTML = html;
}

function changePage(n){
  n = Math.max(1, Math.min(n, Math.ceil(inv.length / itemsPerPage)));
  currentPage = n;
  render();
}

function filter(){ currentPage = 1; render(); }

/* ---------- Add/Edit product (with unit fields) ---------- */
function addItem(){ if(role==='employee'){ alert('Restricted to Owner/Admin'); return } showAddModal(); }

function showAddModal(){
  let m = document.createElement('div');
  m.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000';
  m.id = 'addModal';
  m.innerHTML = `
    <div class="box" style="max-width:640px">
      <h2 style="color:#2d5016;margin-bottom:20px"><span class="emoji">‚ûï</span> Add New Product</h2>
      <input type="text" id="newName" placeholder="Product Name">
      <label style="display:block;text-align:left;font-weight:bold;color:#2d5016;margin-top:8px">Category (type or choose)</label>
      <input list="catDatalist" id="newCat" placeholder="e.g. snacks, drinks, supplies..." style="margin-top:4px">
      <datalist id="catDatalist">
        <option value="snacks">
        <option value="drinks">
        <option value="supplies">
        <option value="canned goods">
        <option value="condiments">
        <option value="personal care">
        <option value="household">
        <option value="frozen goods">
        <option value="bakery">
        <option value="dairy">
        <option value="others">
      </datalist>
      <div style="display:flex;gap:10px">
        <input type="number" id="newQty" placeholder="Quantity" value="0" style="flex:1">
        <input type="number" id="newLow" placeholder="Low-stock threshold" value="5" style="flex:1">
      </div>
      <div style="display:flex;gap:10px">
        <input type="number" id="newCost" placeholder="Cost price (‚Ç±)" style="flex:1">
        <input type="number" id="newPrice" placeholder="Selling price (‚Ç±)" style="flex:1">
      </div>
      <input type="text" id="newSupplier" placeholder="Supplier (optional)">
      <input type="text" id="newBarcode" placeholder="Barcode (optional)">
      <div style="display:flex;gap:10px">
        <label style="flex:1">
          Unit type
          <select id="newUnit">
            <option value="pcs">pcs</option>
            <option value="pack">pack</option>
            <option value="case">case</option>
            <option value="kg">kg</option>
          </select>
        </label>
        <label style="flex:1">
          Unit size (e.g. 6 for 6 pcs/pack)
          <input type="number" id="newUnitSize" placeholder="1" value="1">
        </label>
      </div>
      <input type="date" id="newExp" value="2025-12-31">
      <div style="margin:15px 0">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#2d5016">Upload Image:</label>
        <input type="file" id="newImg" accept="image/*" style="width:100%;padding:8px;border:2px dashed #9acd32;border-radius:5px">
        <img id="imgPreview" style="max-width:100%;max-height:150px;margin-top:10px;display:none;border-radius:5px">
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn btn-success" onclick="saveNewItem()" style="flex:1">Save</button>
        <button class="btn" onclick="closeModal()" style="flex:1;background:#666">Cancel</button>
      </div>
    </div>
  `;
  document.body.appendChild(m);
  document.getElementById('newImg').onchange = function(e){
    let f = e.target.files[0];
    if(f){
      let r = new FileReader();
      r.onload = function(ev){ document.getElementById('imgPreview').src = ev.target.result; document.getElementById('imgPreview').style.display='block'; }
      r.readAsDataURL(f);
    }
  };
}

function saveNewItem(){
  let n = document.getElementById('newName').value.trim(), c = document.getElementById('newCat').value;
  let q = parseInt(document.getElementById('newQty').value) || 0;
  let e = document.getElementById('newExp').value;
  let imgFile = document.getElementById('newImg').files[0];
  let cost = parseFloat(document.getElementById('newCost').value) || 0, price = parseFloat(document.getElementById('newPrice').value) || 0;
  let supplier = document.getElementById('newSupplier').value.trim(), barcode = document.getElementById('newBarcode').value.trim();
  let unit = document.getElementById('newUnit').value || 'pcs', unitSize = parseInt(document.getElementById('newUnitSize').value) || 1, low = parseInt(document.getElementById('newLow').value) || 5;
  if(!n){ alert('Product name required!'); return; }
  if(imgFile){
    let r = new FileReader();
    r.onload = function(ev){
      inv.push({ n, c, q, e, img: ev.target.result, cost, price, supplier, barcode, unit, unitSize, low });
      addNotification('Added new product: ' + n);
      render(); closeModal();
    };
    r.readAsDataURL(imgFile);
  } else {
    inv.push({ n, c, q, e, img: '', cost, price, supplier, barcode, unit, unitSize, low });
    addNotification('Added new product: ' + n);
    render(); closeModal();
  }
}

function closeModal(){ let m = document.getElementById('addModal'); if(m) m.remove(); }
function edit(i){ showEditModal(i, inv[i]); }

function showEditModal(idx, it){
  let m = document.createElement('div');
  m.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000';
  m.id = 'editModal';
  m.innerHTML = `
    <div class="box" style="max-width:640px">
      <h2 style="color:#2d5016;margin-bottom:20px">Edit Product</h2>
      <input type="text" id="editName" value="${escapeHtml(it.n)}" placeholder="Product Name">
      <label style="display:block;text-align:left;font-weight:bold;color:#2d5016;margin-top:8px">Category (type or choose)</label>
      <input list="catDatalistEdit" id="editCat" value="${escapeHtml(it.c)}" placeholder="e.g. snacks, drinks, supplies..." style="margin-top:4px">
      <datalist id="catDatalistEdit">
        <option value="snacks">
        <option value="drinks">
        <option value="supplies">
        <option value="canned goods">
        <option value="condiments">
        <option value="personal care">
        <option value="household">
        <option value="frozen goods">
        <option value="bakery">
        <option value="dairy">
        <option value="others">
      </datalist>
      <div style="display:flex;gap:10px">
        <input type="number" id="editQty" value="${it.q}" placeholder="Quantity" style="flex:1">
        <input type="number" id="editLow" value="${it.low||5}" placeholder="Low-stock threshold" style="flex:1">
      </div>
      <div style="display:flex;gap:10px">
        <input type="number" id="editCost" value="${it.cost||0}" placeholder="Cost price (‚Ç±)" style="flex:1">
        <input type="number" id="editPrice" value="${it.price||0}" placeholder="Selling price (‚Ç±)" style="flex:1">
      </div>
      <input type="text" id="editSupplier" value="${escapeHtml(it.supplier||'')}" placeholder="Supplier (optional)">
      <input type="text" id="editBarcode" value="${escapeHtml(it.barcode||'')}" placeholder="Barcode (optional)">
      <div style="display:flex;gap:10px">
        <label style="flex:1">
          Unit type
          <select id="editUnit">
            <option value="pcs" ${it.unit==='pcs'?'selected':''}>pcs</option>
            <option value="pack" ${it.unit==='pack'?'selected':''}>pack</option>
            <option value="case" ${it.unit==='case'?'selected':''}>case</option>
            <option value="kg" ${it.unit==='kg'?'selected':''}>kg</option>
          </select>
        </label>
        <label style="flex:1">
          Unit size
          <input type="number" id="editUnitSize" value="${it.unitSize||1}">
        </label>
      </div>
      <input type="date" id="editExp" value="${it.e}">
      <div style="margin:15px 0">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#2d5016">Product Image:</label>
        <div id="currentImg" style="margin-bottom:10px">${it.img ? `<div style="position:relative;display:inline-block"><img src="${it.img}" style="max-width:100%;max-height:100px;border-radius:5px"><button onclick="removeEditImg()" class="btn btn-danger" style="position:absolute;top:-8px;right:-8px;padding:4px 8px;font-size:12px;border-radius:50%;margin:0">‚úï</button></div>` : '<p style="color:#999;font-size:12px">No image</p>'}</div>
        <input type="file" id="editImg" accept="image/*" style="width:100%;padding:8px;border:2px dashed #9acd32;border-radius:5px">
        <img id="editPreview" style="max-width:100%;max-height:150px;margin-top:10px;display:none;border-radius:5px">
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn btn-success" onclick="saveEdit(${idx})" style="flex:1">Save</button>
        <button class="btn" onclick="closeEditModal()" style="flex:1;background:#666">Cancel</button>
      </div>
    </div>
  `;
  document.body.appendChild(m);
  document.getElementById('editImg').onchange = function(e){
    let f = e.target.files[0];
    if(f){
      let r = new FileReader();
      r.onload = function(ev){ document.getElementById('editPreview').src = ev.target.result; document.getElementById('editPreview').style.display='block'; document.getElementById('currentImg').innerHTML = '<p style="color:#999;font-size:12px">New image selected</p>'; }
      r.readAsDataURL(f);
    }
  };
}

function removeEditImg(){ document.getElementById('currentImg').innerHTML = '<p style="color:#999;font-size:12px">Image removed</p>'; document.getElementById('currentImg').dataset.removed = 'true'; }

function saveEdit(idx){
  let n = document.getElementById('editName').value.trim(), c = document.getElementById('editCat').value;
  let q = parseInt(document.getElementById('editQty').value) || 0;
  let e = document.getElementById('editExp').value;
  let imgFile = document.getElementById('editImg').files[0];
  let cost = parseFloat(document.getElementById('editCost').value) || 0, price = parseFloat(document.getElementById('editPrice').value) || 0;
  let supplier = document.getElementById('editSupplier').value.trim(), barcode = document.getElementById('editBarcode').value.trim();
  let unit = document.getElementById('editUnit').value || 'pcs', unitSize = parseInt(document.getElementById('editUnitSize').value) || 1, low = parseInt(document.getElementById('editLow').value) || 5;
  if(!n){ alert('Product name required!'); return; }
  let removed = document.getElementById('currentImg').dataset.removed === 'true';
  if(imgFile){
    let r = new FileReader();
    r.onload = function(ev){ inv[idx] = { n, c, q, e, img: ev.target.result, cost, price, supplier, barcode, unit, unitSize, low }; addNotification('Updated product: ' + n); render(); closeEditModal(); };
    r.readAsDataURL(imgFile);
  } else if(removed){
    inv[idx] = { ...inv[idx], n, c, q, e, img: '', cost, price, supplier, barcode, unit, unitSize, low };
    addNotification('Updated product: ' + n); render(); closeEditModal();
  } else {
    inv[idx] = { ...inv[idx], n, c, q, e, cost, price, supplier, barcode, unit, unitSize, low };
    addNotification('Updated product: ' + n); render(); closeEditModal();
  }
}

function closeEditModal(){ let m = document.getElementById('editModal'); if(m) m.remove(); }

/* ---------- basic ---------- */
function doLogout(){ if(confirm('Logout?')) location.reload(); }
function toggleMenu(){ document.getElementById('nav').classList.toggle('hidden'); }
function goTo(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  let sec = document.getElementById(id); if(sec) sec.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  let navs = Array.from(document.querySelectorAll('.nav-item'));
  let match = navs.find(n=>{ let oc = n.getAttribute('onclick') || ''; return oc.includes("'" + id + "'") || oc.includes('"' + id + '"') || oc.includes(id); });
  if(match) match.classList.add('active');
  if(id==='admin' || id==='settings') loadAdmin();
  if(id==='notif') loadNot();
  if(id==='utang') loadCustomers();
  if(id==='suppliers') loadSuppliers();
  if(id==='purchase') loadPurchases();
  if(id==='reports') renderReports();
}

/* delete inventory */
function del(i){ if(confirm('Delete this item?')){ addNotification('Deleted product: ' + (inv[i] && inv[i].n ? inv[i].n : ('index '+i))); inv.splice(i,1); render(); } }

/* announcements */
function postAnn(){ let t = document.getElementById('ann').value; if(!t) return; ann = t; save(); showAnn(); alert('Posted!'); }
function showAnn(){ let b = document.getElementById('announce'); b.innerHTML = ann ? `<strong>üì£ Admin:</strong> ${escapeHtml(ann)}` : 'No announcements.'; }

/* export CSV (includes unit columns) */
function exportCSV(){
  let csv = 'Product,Category,Quantity,Unit,UnitSize,Expiry,Cost,Price,Supplier,Barcode\n';
  inv.forEach(i => {
    csv += `"${escapeCsv(i.n)}","${escapeCsv(i.c)}",${i.q},"${i.unit||'pcs'}",${i.unitSize||1},"${i.e || ''}",${i.cost||''},${i.price||''},"${escapeCsv(i.supplier||'')}","${escapeCsv(i.barcode||'')}"\n`;
  });
  let b = new Blob([csv], { type: 'text/csv' }), a = document.createElement('a');
  a.href = URL.createObjectURL(b); a.download = 'stall18_inventory.csv'; a.click();
}

/* notifications per-account */
function loadNot(){
  let list = (user && nots[user]) ? nots[user] : [];
  let h = '';
  list.forEach((n, i) => h += `<div style="background:#e3f2fd;padding:12px;margin:10px 0;border-radius:6px;border-left:4px solid #2196f3;display:flex;justify-content:space-between;align-items:center"><span>${escapeHtml(n)}</span><button class="btn btn-danger" onclick="delNotif(${i})" style="margin:0;padding:6px 12px;font-size:12px">‚úï</button></div>`);
  document.getElementById('notlist').innerHTML = h || '<p>No notifications.</p>';
  updateNotifBadge();
}
function delNotif(i){ if(!user || !nots[user]) return; nots[user].splice(i,1); save(); loadNot(); }
function clearNotif(){ if(!user) return; if(confirm('Clear all your notifications?')){ nots[user]=[]; save(); loadNot(); } }

/* ---------- accounts / admin flows ---------- */
function loadAdmin(){
  if(role==='admin'){
    let h = '';
    pending.forEach((p,i) => h += `<div class="acc-item pending"><div><strong>${p.u}</strong> (${p.r})</div><div><button class="btn btn-success" onclick="app(${i})">Approve</button></div></div>`);
    document.getElementById('pend').innerHTML = h || '<p>No pending requests.</p>';

    let rHtml = '';
    recoveryRequests.forEach((rq,i) => {
      rHtml += `<div class="acc-item"><div><strong>${escapeHtml(rq.username)}</strong> (${rq.role})<div class="small-muted" style="margin-top:6px">${escapeHtml(rq.reason)}</div><div class="small-muted" style="margin-top:6px">${escapeHtml(rq.date)}</div></div><div><button class="btn btn-success" onclick="resolveRecovery(${i})">Resolve</button></div></div>`;
    });
    document.getElementById('recreq').innerHTML = rHtml || '<p>No recovery requests.</p>';

    let all = '';
    for(let k in users){
      users[k].forEach((ac, idx) => {
        let statusText = ac.ok ? 'Active' : 'Deactivated';
        if(k === 'admin'){
          all += `<div class="acc-item"><div><strong>${escapeHtml(ac.u)}</strong> <span class="small-muted">(${k})</span><div class="small-muted" style="margin-top:6px">Status: ${statusText}</div></div><div><span class="small-muted">Protected</span></div></div>`;
        } else {
          let actionButtons = `<button class="btn btn-danger" onclick="deleteAccount('${k}',${idx})">Delete</button>`;
          actionButtons += `<button class="btn" onclick="toggleAccountActive('${k}',${idx})">${ac.ok? 'Deactivate':'Reactivate'}</button>`;
          all += `<div class="acc-item"><div><strong>${escapeHtml(ac.u)}</strong> <span class="small-muted">(${k})</span><div class="small-muted" style="margin-top:6px">Status: ${statusText}</div></div><div>${actionButtons}</div></div>`;
        }
      });
    }
    document.getElementById('accs').innerHTML = all || '<p>No accounts.</p>';
  } else {
    document.getElementById('pend').innerHTML = '<p>Admin only</p>';
    document.getElementById('recreq').innerHTML = '<p>Admin only</p>';
    document.getElementById('accs').innerHTML = '';
  }
}

/* approve pending */
function app(i){ let p = pending[i]; if(!users[p.r]) users[p.r] = []; users[p.r].push({ u: p.u, p: p.p, ok: 1 }); pending.splice(i,1); save(); loadAdmin(); alert('Approved '+p.u); loadAccountsView(); }

/* resolve recovery */
function resolveRecovery(i){
  if(role!=='admin'){ alert('Only admin can resolve recovery requests'); return; }
  let rq = recoveryRequests[i];
  if(!rq){ alert('Not found'); return; }
  let newPass = prompt(`Set a new password for user "${rq.username}" (${rq.role}) ‚Äî leave blank to cancel:`);
  if(!newPass){ return; }
  if(!users[rq.role]) users[rq.role] = [];
  let found = users[rq.role].find(u=>u.u===rq.username);
  if(found){ found.p = newPass; found.ok = 1; alert(`Password updated for existing user ${rq.username}`); }
  else { users[rq.role].push({ u: rq.username || ('user'+Date.now()), p: newPass, ok: 1}); alert(`Created new ${rq.role} account: ${rq.username}`); }
  recoveryRequests.splice(i,1);
  save(); loadAdmin(); loadAccountsView();
}

/* submit recovery request */
function submitRecoveryRequest(){
  let r = document.getElementById('recRole').value;
  let u = document.getElementById('recUser').value.trim();
  let reason = document.getElementById('recReason').value.trim();
  let e = document.getElementById('recErr');
  e.innerText = '';
  if(!r || !reason){ e.innerText='Please fill role and describe your issue'; return; }
  recoveryRequests.push({ role: r, username: u || 'Unknown', reason: reason, date: new Date().toLocaleString() });
  save();
  alert('‚úì Recovery request submitted! Admin will review your request.');
  document.getElementById('recRole').value=''; document.getElementById('recUser').value=''; document.getElementById('recReason').value='';
  toLogin(); loadAdmin();
}

/* admin emergency recovery */
function adminRecovery(){
  let code = document.getElementById('emergencyCode').value.trim();
  if(code === 'RESET2025'){
    let adminUser = users.admin && users.admin[0] ? users.admin[0] : null;
    let newUsername = prompt('Enter new admin username: (leave blank to keep current)');
    if(newUsername && newUsername.length < 3){ alert('Username must be at least 3 characters'); document.getElementById('emergencyCode').value=''; return; }
    let newPassword = prompt('Enter new admin password: (leave blank to keep current)');
    if(!adminUser){
      users.admin = users.admin || [];
      users.admin[0] = { u: (newUsername || 'admin'), p: (newPassword || 'admin123'), ok: 1 };
      alert('‚úì Admin account created.');
    } else {
      if(newUsername) adminUser.u = newUsername;
      if(newPassword) adminUser.p = newPassword;
      adminUser.ok = 1;
      alert('‚úì Admin credentials updated.');
    }
    save();
    document.getElementById('emergencyCode').value='';
    toLogin();
  } else {
    alert('‚ùå Invalid emergency code! Contact system administrator.');
  }
}

/* account protections */
function deleteAccount(roleName, idx){
  if(role!=='admin'){ alert('Only admin can delete accounts'); return; }
  if(roleName==='admin'){ alert('Admin accounts cannot be deleted'); return; }
  if(!confirm(`Delete account ${users[roleName][idx].u} (${roleName})?`)) return;
  users[roleName].splice(idx,1);
  save(); loadAdmin(); loadAccountsView();
}
function toggleAccountActive(roleName, idx){
  if(role!=='admin'){ alert('Only admin can change account status'); return; }
  if(roleName==='admin'){ alert('Admin accounts cannot be deactivated/reactivated'); return; }
  let acc = users[roleName][idx]; if(!acc) return; acc.ok = acc.ok ? 0 : 1; save(); loadAdmin(); loadAccountsView();
}

function loadAccountsView(){
  let h = '';
  for(let k in users){
    users[k].forEach((a,i) => h += `<div class="acc-item"><div><strong>${escapeHtml(a.u)}</strong> <span class="small-muted">(${k})</span><div class="small-muted" style="margin-top:6px">Status: ${a.ok? 'Active':'Deactivated'}</div></div></div>`);
  }
  document.getElementById('actacc').innerHTML = h || '<p>No active accounts.</p>';
}

/* change pass/username */
function changePass(){ let c = document.getElementById('curr').value, n = document.getElementById('new').value, n2 = document.getElementById('new2').value; if(!c||!n||!n2){ alert('Fill all'); return } if(n!==n2){ alert('New passwords do not match'); return } let u = users[role].find(x=>x.u===user); if(!u||u.p!==c){ alert('Wrong current password'); return } u.p = n; save(); alert('Password updated!'); document.getElementById('curr').value=''; document.getElementById('new').value=''; document.getElementById('new2').value=''; }
function changeUsername(){ let newU = document.getElementById('newUsername').value.trim(); if(!newU){ alert('Enter new username'); return } if(users[role].some(x=>x.u===newU&&x.u!==user)){ alert('Username already taken'); return } let u = users[role].find(x=>x.u===user); if(!u){ alert('Error finding account'); return } u.u = newU; let oldUser = user; user = newU; save(); document.getElementById('uinfo').innerText = user+' ('+role.toUpperCase()+')'; document.getElementById('currentUser').innerText = user; alert('Username updated from "'+oldUser+'" to "'+newU+'"!'); document.getElementById('newUsername').value=''; loadAccountsView(); }

/* ---------- Branding (admin-only) ---------- */
function saveBranding(){
  if(role!=='admin'){ alert('Only admin can change branding (logo or login background).'); return; }
  let logoFile = document.getElementById('brandLogo').files[0];
  let bgFile = document.getElementById('brandBg').files[0];
  let payload = JSON.parse(localStorage.getItem('branding') || '{}');
  if(logoFile){
    let r = new FileReader();
    r.onload = function(ev){
      payload.logo = ev.target.result;
      if(document.getElementById('headerLogo')) document.getElementById('headerLogo').src = payload.logo;
      if(document.getElementById('mainLogo')) document.getElementById('mainLogo').src = payload.logo;
      if(document.getElementById('brandLogoPreview')) document.getElementById('brandLogoPreview').src = payload.logo;
      localStorage.setItem('branding', JSON.stringify(payload));
      alert('Branding saved!');
    };
    r.readAsDataURL(logoFile);
  }
  if(bgFile){
    let r2 = new FileReader();
    r2.onload = function(ev){
      payload.bg = ev.target.result;
      localStorage.setItem('branding', JSON.stringify(payload));
      applyBranding(payload);
      alert('Background saved! (login page updated)');
    };
    r2.readAsDataURL(bgFile);
  }
  if(!logoFile && !bgFile){ alert('Choose logo or background file first.'); return; }
}

function applyBranding(payload){
  try {
    if(payload.logo){
      if(document.getElementById('headerLogo')) document.getElementById('headerLogo').src = payload.logo;
      if(document.getElementById('mainLogo')) document.getElementById('mainLogo').src = payload.logo;
      if(document.getElementById('brandLogoPreview')) document.getElementById('brandLogoPreview').src = payload.logo;
    }
    if(payload.bg){
      let loginEl = document.getElementById('login');
      if(loginEl){
        loginEl.style.backgroundImage = `url(${payload.bg})`;
        loginEl.style.backgroundSize = 'cover';
        loginEl.style.backgroundPosition = 'center';
      }
      if(document.getElementById('bgPreview')){
        document.getElementById('bgPreview').src = payload.bg;
        document.getElementById('bgPreview').style.display='block';
      }
    } else {
      resetLoginBackgroundToDefault();
      if(document.getElementById('bgPreview')) document.getElementById('bgPreview').style.display='none';
    }
  } catch(e){ console.warn('applyBranding failed', e) }
}
function resetLoginBackgroundToDefault(){
  let loginEl = document.getElementById('login');
  if(loginEl){
    loginEl.style.backgroundImage = '';
    loginEl.style.background = 'linear-gradient(135deg,#2d5016,#6b8e23)';
  }
}
function clearBranding(){
  if(role!=='admin'){ alert('Only admin can clear branding.'); return; }
  localStorage.removeItem('branding');
  if(document.getElementById('headerLogo')) document.getElementById('headerLogo').src = 'logo.png';
  if(document.getElementById('mainLogo')) document.getElementById('mainLogo').src = '1000017768.png';
  resetLoginBackgroundToDefault();
  if(document.getElementById('brandLogoPreview')) document.getElementById('brandLogoPreview').src='logo.png';
  if(document.getElementById('bgPreview')) document.getElementById('bgPreview').style.display='none';
  alert('Branding cleared.');
}

/* ---------- Sales modal / flows ---------- */
function openSalesModal(){
  let m = document.createElement('div');
  m.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000';
  m.id = 'salesModal';
  let options = inv.map((it,i) => `<option value="${i}">${escapeHtml(it.n)} (‚Ç±${it.price||'0'}) ‚Äî ${it.q}${it.unit?(' '+it.unit):''}</option>`).join('');
  let custOptions = customers.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
  m.innerHTML = `
    <div class="box" style="max-width:480px">
      <h2 style="color:#2d5016;margin-bottom:10px">New Sale</h2>
      <label>Product</label>
      <select id="saleProduct">${options}</select>
      <div style="display:flex;gap:10px">
        <input type="number" id="saleQty" value="1" min="1" style="flex:1">
        <input type="number" id="salePrice" placeholder="Price" style="flex:1">
      </div>
      <label>Sale Type</label>
      <select id="saleType"><option value="cash">Cash</option><option value="utang">Utang (Credit)</option></select>
      <div id="saleCustomerRow" style="display:none">
        <label>Customer (utang)</label>
        <select id="saleCustomer">${custOptions}</select>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn btn-success" onclick="saveSale()">Record Sale</button>
        <button class="btn" onclick="closeSaleModal()" style="background:#666">Cancel</button>
      </div>
    </div>
  `;
  document.body.appendChild(m);
  let sp = document.getElementById('saleProduct');
  if(sp) sp.onchange = function(){ let it = inv[this.value]; document.getElementById('salePrice').value = it ? it.price : ''; };
  let st = document.getElementById('saleType');
  if(st) st.onchange = function(){ document.getElementById('saleCustomerRow').style.display = this.value === 'utang' ? 'block' : 'none'; };
}
function closeSaleModal(){ let m = document.getElementById('salesModal'); if(m) m.remove(); }
function saveSale(){
  let pIdx = parseInt(document.getElementById('saleProduct').value); if(isNaN(pIdx)){ alert('Choose product'); return; }
  let qty = parseInt(document.getElementById('saleQty').value) || 0; if(qty <= 0){ alert('Qty must be > 0'); return; }
  let price = parseFloat(document.getElementById('salePrice').value) || 0; let type = document.getElementById('saleType').value;
  let prod = inv[pIdx];
  if(!prod){ alert('Product not found'); return; }
  if(prod.q < qty){ if(!confirm('Not enough stock. Continue and allow negative stock?')) return; }
  prod.q = prod.q - qty;
  let total = qty * price;
  let saleRecord = { product: prod.n, product_idx: pIdx, qty, price, total, type, date: new Date().toLocaleString(), user };
  if(type === 'utang'){
    let custId = document.getElementById('saleCustomer').value; let cust = customers.find(c => c.id == custId);
    if(!cust){ alert('Choose customer for utang'); return; }
    cust.balance = (cust.balance || 0) + total;
    saleRecord.customer = cust.name; saleRecord.customerId = cust.id;
  }
  sales.push(saleRecord);
  addNotification(`Sale recorded: ${qty} x ${prod.n} (${type}) ‚Ç±${total}`);
  save(); render(); closeSaleModal(); alert('Sale recorded!');
}

function openSalesHistory(){
  let el = document.getElementById('salesHistory'); el.style.display = 'block';
  if(sales.length === 0){ el.innerHTML = '<p>No sales yet.</p>'; return; }
  let html = `<table><thead><tr><th>#</th><th>Date</th><th>Product</th><th>Qty</th><th>Price</th><th>Total</th><th>Type</th><th>Customer</th></tr></thead><tbody>`;
  sales.slice().reverse().forEach((s,i) => { html += `<tr><td>${i+1}</td><td>${s.date}</td><td>${escapeHtml(s.product)}</td><td>${s.qty}</td><td>‚Ç±${s.price}</td><td>‚Ç±${s.total}</td><td>${s.type}</td><td>${escapeHtml(s.customer||'‚Äî')}</td></tr>`; });
  html += '</tbody></table>';
  el.innerHTML = html;
}

/* ---------- Customers / Utang ---------- */
function loadCustomers(){
  let now = new Date(); now.setHours(0,0,0,0);
  document.getElementById('customerList').innerHTML = customers.length ? customers.map(c => {
    let dueTxt = '';
    let overdue = false;
    if(c.dueDate){
      let dd = new Date(c.dueDate); dd.setHours(0,0,0,0);
      overdue = (c.balance > 0) && dd < now;
      let dueLabel = overdue
        ? `<span style="color:#dc3545;font-weight:bold">‚ö†Ô∏è OVERDUE: ${c.dueDate}</span>`
        : `<span style="color:#666">Due: ${c.dueDate}</span>`;
      dueTxt = `<div class="small-muted">${dueLabel}</div>`;
    }
    return `<div class="acc-item" style="${overdue?'border-left:4px solid #dc3545;':''}">
      <div>
        <strong>${escapeHtml(c.name)}</strong>
        <div class="small-muted">Outstanding: ‚Ç±${(c.balance||0).toFixed(2)}</div>
        ${dueTxt}
      </div>
      <div>
        <button class="btn" onclick="openCustomerDetails('${c.id}')">Open</button>
        <button class="btn" onclick="editCustomerDueDate('${c.id}')" style="background:#ffc107;color:#333">Set Due</button>
      </div>
    </div>`;
  }).join('') : '<p>No customers yet.</p>';
  save();
}

function editCustomerDueDate(id){
  let c = customers.find(x=>x.id==id); if(!c) return;
  let dd = prompt('Set due date for ' + c.name + ' (YYYY-MM-DD, blank to remove):', c.dueDate||'');
  if(dd === null) return;
  c.dueDate = dd.trim();
  save(); loadCustomers();
}
function openAddCustomer(){
  let name = prompt('Customer name:'); if(!name) return;
  let dueDate = prompt('Due date for payment (YYYY-MM-DD, optional):') || '';
  let id = 'c' + Date.now();
  customers.push({ id, name, balance: 0, dueDate });
  save(); loadCustomers(); alert('Customer added.');
}
function openCustomerDetails(id){
  let c = customers.find(x=>x.id==id); if(!c) return;
  let m = document.createElement('div');
  m.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000';
  m.id = 'custModal';
  let now = new Date(); now.setHours(0,0,0,0);
  let overdue = c.dueDate && c.balance > 0 && new Date(c.dueDate) < now;
  let dueLine = c.dueDate ? `<p style="margin-top:6px;color:${overdue?'#dc3545':'#666'}"><strong>Due Date:</strong> ${c.dueDate} ${overdue?'<span style="background:#dc3545;color:#fff;padding:2px 8px;border-radius:4px;font-size:12px">OVERDUE</span>':''}</p>` : '<p style="margin-top:6px;color:#999">No due date set</p>';
  m.innerHTML = `<div class="box" style="max-width:420px">
    <h2 style="color:#2d5016;margin-bottom:10px">${escapeHtml(c.name)}</h2>
    <p>Outstanding: ‚Ç±${(c.balance||0).toFixed(2)}</p>
    ${dueLine}
    <label style="margin-top:12px;display:block">Payment amount</label>
    <input type="number" id="payAmt" value="0">
    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="btn btn-success" onclick="recordUtangPayment('${c.id}')">Record Payment</button>
      <button class="btn" onclick="closeCustomerModal()" style="background:#666">Close</button>
    </div>
  </div>`;
  document.body.appendChild(m);
}
function closeCustomerModal(){ let m = document.getElementById('custModal'); if(m) m.remove(); }
function recordUtangPayment(id){ let amt = parseFloat(document.getElementById('payAmt').value) || 0; if(amt <= 0){ alert('Enter amount'); return; } let c = customers.find(x=>x.id==id); if(!c) return; c.balance = Math.max(0, (c.balance||0) - amt); addNotification(`Payment recorded: ${c.name} ‚Ç±${amt}`); save(); loadCustomers(); closeCustomerModal(); alert('Payment recorded'); }
function openUtangPayments(){ let id = prompt('Enter customer ID (or leave blank to select):'); if(!id){ loadCustomers(); return; } openCustomerDetails(id); }

/* ---------- Suppliers & Purchases ---------- */
function loadSuppliers(){ document.getElementById('supplierList').innerHTML = suppliers.length ? suppliers.map(s => `<div class="acc-item"><div><strong>${escapeHtml(s.name)}</strong><div class="small-muted">Contact: ${escapeHtml(s.contact||'‚Äî')}</div></div></div>`).join('') : '<p>No suppliers yet.</p>'; }
function openAddSupplier(){ let name = prompt('Supplier name:'); if(!name) return; let contact = prompt('Contact info (optional)'); suppliers.push({ id: 's' + Date.now(), name, contact }); save(); loadSuppliers(); alert('Supplier added'); }

function openPurchaseModal(){
  if(suppliers.length === 0){ if(!confirm('No suppliers found. Add one now?')) return; openAddSupplier(); }
  let m = document.createElement('div');
  m.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000';
  m.id = 'purchaseModal';
  let prodOptions = inv.map((it,i) => `<option value="${i}">${escapeHtml(it.n)} ‚Äî ${it.q}pcs</option>`).join('');
  let supOptions = suppliers.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
  m.innerHTML = `<div class="box" style="max-width:500px"><h2 style="color:#2d5016;margin-bottom:10px">New Purchase / Restock</h2><label>Supplier</label><select id="purSupplier">${supOptions}</select><label>Product</label><select id="purProduct">${prodOptions}</select><div style="display:flex;gap:10px"><input type="number" id="purQty" value="1" min="1" style="flex:1"><input type="number" id="purCost" placeholder="Cost each" style="flex:1"></div><div style="display:flex;gap:10px;margin-top:12px"><button class="btn btn-success" onclick="savePurchase()">Receive Stock</button><button class="btn" onclick="closePurchaseModal()" style="background:#666">Cancel</button></div></div>`;
  document.body.appendChild(m);
}
function closePurchaseModal(){ let m = document.getElementById('purchaseModal'); if(m) m.remove(); }
function savePurchase(){
  let idx = parseInt(document.getElementById('purProduct').value); let qty = parseInt(document.getElementById('purQty').value) || 0; if(qty <= 0){ alert('Qty > 0'); return; }
  let cost = parseFloat(document.getElementById('purCost').value) || 0; let supplierId = document.getElementById('purSupplier').value; let supplierObj = suppliers.find(s=>s.id==supplierId);
  if(idx < 0 || !inv[idx]){ alert('Choose product'); return; }
  inv[idx].q = (inv[idx].q||0) + qty; inv[idx].cost = cost || inv[idx].cost; inv[idx].supplier = supplierObj ? supplierObj.name : inv[idx].supplier;
  purchases.push({ date: new Date().toLocaleString(), product: inv[idx].n, qty, cost, supplier: supplierObj ? supplierObj.name : '‚Äî' });
  addNotification(`Stock updated: ${inv[idx].n} +${qty}`);
  save(); render(); closePurchaseModal(); loadPurchases(); alert('Stock received');
}

function loadPurchases(){ document.getElementById('purchaseList').innerHTML = purchases.length ? `<table><thead><tr><th>#</th><th>Date</th><th>Product</th><th>Qty</th><th>Cost</th><th>Supplier</th></tr></thead><tbody>` + purchases.slice().reverse().map((p,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(p.date)}</td><td>${escapeHtml(p.product)}</td><td>${p.qty}</td><td>‚Ç±${p.cost}</td><td>${escapeHtml(p.supplier)}</td></tr>`).join('') + '</tbody></table>' : '<p>No purchases yet.</p>'; }

/* ---------- Reports ---------- */
function renderReports(){
  let totalSales = 0; let cashSales = 0; let utangSales = 0; let perItem = {};
  sales.forEach(s => { totalSales += s.total; if(s.type==='cash') cashSales += s.total; else utangSales += s.total; perItem[s.product] = (perItem[s.product]||0) + s.total; });
  let topItems = Object.keys(perItem).sort((a,b)=>perItem[b]-perItem[a]).slice(0,5).map(k=>`${escapeHtml(k)} (‚Ç±${perItem[k].toFixed(2)})`).join('<br>');
  document.getElementById('reportSummary').innerHTML = `<p><strong>Total Sales:</strong> ‚Ç±${totalSales.toFixed(2)}</p><p><strong>Cash:</strong> ‚Ç±${cashSales.toFixed(2)} &nbsp;&nbsp; <strong>Utang:</strong> ‚Ç±${utangSales.toFixed(2)}</p><h4>Top items</h4><p>${topItems||'No sales yet'}</p>`;
}

/* ---------- Backup / Export / Import ---------- */
function exportData(){
  let payload = { users, inv, pending, nots, ann, recoveryRequests, sales, customers, suppliers, purchases };
  let b = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' }), a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'sari-sari-backup.json'; a.click();
}
function importData(){
  let f = document.getElementById('importFile').files[0]; if(!f){ alert('Choose JSON file to import'); return; }
  let r = new FileReader(); r.onload = function(ev){ try { let payload = JSON.parse(ev.target.result); if(confirm('Import will overwrite current data. Continue?')){ users = payload.users || users; inv = payload.inv || inv; pending = payload.pending || pending; nots = payload.nots || nots; ann = payload.ann || ann; recoveryRequests = payload.recoveryRequests || recoveryRequests; sales = payload.sales || sales; customers = payload.customers || customers; suppliers = payload.suppliers || suppliers; purchases = payload.purchases || purchases; save(); render(); loadCustomers(); loadSuppliers(); loadPurchases(); alert('Import complete'); } } catch(e){ alert('Invalid JSON file'); } }; r.readAsText(f);
}

/* ---------- Auto Alert System ---------- */
function updateNotifBadge(){
  let list = (user && nots[user]) ? nots[user] : [];
  let badge = document.getElementById('notifBadge');
  if(!badge) return;
  if(list.length > 0){ badge.style.display='inline'; badge.innerText = list.length > 99 ? '99+' : list.length; }
  else badge.style.display='none';
}

function autoCheckAlerts(){
  let now = new Date(); now.setHours(0,0,0,0);
  let expiredItems = [], outItems = [], overdueCustomers = [];

  inv.forEach(it => {
    if(it.e && new Date(it.e) < now) expiredItems.push(it.n);
    if(it.q === 0) outItems.push(it.n);
  });

  customers.forEach(c => {
    if(c.dueDate && c.balance > 0){
      let dd = new Date(c.dueDate); dd.setHours(0,0,0,0);
      if(dd < now) overdueCustomers.push({ name: c.name, balance: c.balance, dueDate: c.dueDate });
    }
  });

  // Add to notifications (avoid duplicates by checking today's date prefix)
  let todayStr = new Date().toLocaleDateString();
  if(!nots[user]) nots[user] = [];
  let existingToday = nots[user].filter(n => n.startsWith('[AUTO ' + todayStr + ']'));
  if(existingToday.length === 0){
    expiredItems.forEach(n => addNotification('[AUTO ' + todayStr + '] ‚õî EXPIRED: ' + n));
    outItems.forEach(n => addNotification('[AUTO ' + todayStr + '] üì¶ OUT OF STOCK: ' + n));
    overdueCustomers.forEach(c => addNotification('[AUTO ' + todayStr + '] üí≥ OVERDUE UTANG: ' + c.name + ' ‚Äî ‚Ç±' + c.balance.toFixed(2) + ' (due: ' + c.dueDate + ')'));
  }

  // Show popup if any alerts
  if(expiredItems.length === 0 && outItems.length === 0 && overdueCustomers.length === 0){
    updateNotifBadge(); return;
  }

  let overlay = document.createElement('div');
  overlay.className = 'alert-modal-overlay';
  overlay.id = 'alertModal';
  let html = `<div class="alert-modal-box">
    <h2 style="color:#c0392b;margin-bottom:16px">‚ö†Ô∏è Store Alerts</h2>
    <p style="color:#666;margin-bottom:16px;font-size:0.92rem">Mga bagay na kailangan ng iyong atensyon:</p>`;

  if(expiredItems.length > 0){
    html += `<div class="alert-section expired">
      <strong style="color:#dc3545">‚õî Expired Products (${expiredItems.length})</strong>
      ${expiredItems.map(n=>`<div class="alert-item">‚Ä¢ ${escapeHtml(n)}</div>`).join('')}
    </div>`;
  }

  if(outItems.length > 0){
    html += `<div class="alert-section outstock">
      <strong style="color:#e65100">üì¶ Out of Stock (${outItems.length})</strong>
      ${outItems.map(n=>`<div class="alert-item">‚Ä¢ ${escapeHtml(n)}</div>`).join('')}
    </div>`;
  }

  if(overdueCustomers.length > 0){
    html += `<div class="alert-section overdue">
      <strong style="color:#e53935">üí≥ Overdue Utang (${overdueCustomers.length})</strong>
      ${overdueCustomers.map(c=>`<div class="alert-item">‚Ä¢ ${escapeHtml(c.name)} ‚Äî ‚Ç±${c.balance.toFixed(2)} <span style="color:#dc3545;font-size:11px">(due: ${c.dueDate})</span></div>`).join('')}
    </div>`;
  }

  html += `<div style="display:flex;gap:10px;margin-top:20px">
    <button class="btn btn-success" onclick="closeAlertModal()" style="flex:1">OK, Sige!</button>
    <button class="btn" onclick="closeAlertModal();goTo('notif')" style="flex:1;background:#2196f3">View Notifications</button>
  </div></div>`;

  overlay.innerHTML = html;
  document.body.appendChild(overlay);
  updateNotifBadge();
}

function closeAlertModal(){ let m = document.getElementById('alertModal'); if(m) m.remove(); updateNotifBadge(); }

/* ---------- Initial render ---------- */
render();

/* ---------- Helpers ---------- */
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }
function escapeCsv(s){ if(!s && s!==0) return ''; return String(s).replace(/"/g, '""'); }
</script>
</body>
</html>
